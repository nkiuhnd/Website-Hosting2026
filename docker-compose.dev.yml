version: '3.8'

services:
  web-hosting-platform:
    build:
      context: .
      # 使用 server-builder 阶段，这样有环境，但我们会覆盖 CMD
      target: server-builder 
    ports:
      - "4000:4000"
    volumes:
      - ./server/src:/app/server/src  # 挂载源码，支持后端热重载
      - ./server/.env:/app/server/.env
      - ./server/prisma:/app/server/prisma
      # 关键：挂载本地构建好的前端 dist，模拟生产环境
      - ./client/dist:/app/client/dist 
    environment:
      - NODE_ENV=development
      # 覆盖 .env 里的 Redis 配置，指向 docker 服务名
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # 让 nodemon 监听 ts 文件变化
    working_dir: /app/server
    # 安装依赖（利用缓存）并启动后端开发模式
    # 注意：这里假设你 package.json 里有 "dev": "nodemon src/index.ts" 或类似命令
    # 如果没有，可以用 npx ts-node src/index.ts
    command: sh -c "npm install && npx prisma generate && npx ts-node src/index.ts"
    restart: on-failure
    networks:
      - web-network
  
  # Nginx 服务配置
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - web-hosting-platform
    restart: unless-stopped
    networks:
      - web-network

  # Redis 服务
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - web-network

volumes:
  redis_data:

networks:
  web-network:
    driver: bridge
